name: BC CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Also deploy the built app to a BC environment'
        type: boolean
        required: false
        default: false
      environment:
        description: 'Target BC environment name (Admin Center)'
        type: string
        required: false
        default: 'Sandbox'

jobs:
  build:
    name: Build AL app
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log run context
        shell: pwsh
        run: |
          Write-Host "Workflow commit SHA: $env:GITHUB_SHA"
          Write-Host "Runner OS: $env:RUNNER_OS"

      - name: Cache BcContainerHelper module
        uses: actions/cache@v4
        with:
          path: ~\Documents\PowerShell\Modules\BcContainerHelper
          key: bccontainerhelper-${{ runner.os }}-v6
          restore-keys: |
            bccontainerhelper-${{ runner.os }}-

      - name: Setup PowerShell Gallery trust and install BcContainerHelper
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          if (Get-Module -ListAvailable -Name BcContainerHelper) {
            Write-Host "Using cached BcContainerHelper module"
            Import-Module BcContainerHelper -Force
          }
          else {
            Write-Host "Installing BcContainerHelper from PSGallery"
            Install-Module BcContainerHelper -Scope CurrentUser -Force
            Import-Module BcContainerHelper -Force
          }

      - name: Resolve BC artifacts
        id: artifacts
        shell: pwsh
        run: |
          $artifactUrl = Get-BCArtifactUrl -type 'Sandbox' -select 'Latest' -country 'gb'
          echo "artifactUrl=$artifactUrl" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Cache AL symbols (.alpackages)
        uses: actions/cache@v4
        with:
          path: .alpackages
          key: alpkgs-${{ runner.os }}-${{ hashFiles('app.json') }}-${{ steps.artifacts.outputs.artifactUrl }}
          restore-keys: |
            alpkgs-${{ runner.os }}-${{ hashFiles('app.json') }}-
            alpkgs-${{ runner.os }}-

      - name: Build in ephemeral BC container
        shell: pwsh
        env:
          ARTIFACT_URL: ${{ steps.artifacts.outputs.artifactUrl }}
        run: |
          # Ensure BcContainerHelper is imported in this step/session
          Import-Module BcContainerHelper -ErrorAction Stop
          Write-Host "BcContainerHelper version:" (Get-Module BcContainerHelper).Version
          $cmd = Get-Command Download-BcContainerAppSymbols -ErrorAction SilentlyContinue
          if (-not $cmd) { Write-Host "Download-BcContainerAppSymbols not found in module, continuing after container creation (module may autoload)" }

          $containerName = "bcbuild$($env:GITHUB_RUN_NUMBER)"
          # Provide mandatory credentials for -auth UserPassword
          $securePwd = ConvertTo-SecureString ("P@ssw0rd!$($env:GITHUB_RUN_NUMBER)") -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("admin", $securePwd)
          New-BcContainer `
            -accept_eula `
            -containerName $containerName `
            -artifactUrl $env:ARTIFACT_URL `
            -auth UserPassword `
            -Credential $credential `
            -updateHosts `
            -enableTaskScheduler:$false

          try {
            # Re-import module and ensure symbols downloaded to HOST first (host path shares not reliable for direct compile)
            Import-Module BcContainerHelper -ErrorAction Stop
            $symbolCmd = @('Download-BcContainerAppSymbols','Get-BcContainerAppSymbols') | ForEach-Object { Get-Command $_ -ErrorAction SilentlyContinue } | Select-Object -First 1
            if ($null -ne $symbolCmd) {
              Write-Host "Downloading symbols to host using: $($symbolCmd.Name)"
              & $symbolCmd.Name -containerName $containerName -appProjectFolder $Env:GITHUB_WORKSPACE -AddGITUserToContainer
            } else { Write-Host "No symbol download command found; continuing" }

            # Copy project (now with symbols) into container path c:\app
            Write-Host "Copying project into container path c:\app"
            # Copy-FileToBcContainer copies directories recursively by default; removed unsupported -includeSubFolders parameter
            Copy-FileToBcContainer -containerName $containerName -localPath $Env:GITHUB_WORKSPACE -containerPath "c:\app"

            # Prepare artifacts folder on host
            New-Item -ItemType Directory -Force -Path "$Env:GITHUB_WORKSPACE\artifacts" | Out-Null

            # Compile from inside-container path, output to container path then copy back to host
            $containerOutput = "c:\app\output"
            Compile-AppInBCContainer `
              -containerName $containerName `
              -appProjectFolder "c:\app" `
              -appOutputFolder $containerOutput `
              -EnableCodeCop:$true `
              -EnableAppSourceCop:$false `
              -EnablePerTenantExtensionCop:$true

            Write-Host "Copy compiled artifacts from container to host artifacts folder"
            Copy-FileFromBcContainer -containerName $containerName -containerPath $containerOutput -localPath "$Env:GITHUB_WORKSPACE\artifacts" -silent

            Write-Host "Listing .alpackages after compile (if present)";
            if (Test-Path "$Env:GITHUB_WORKSPACE\.alpackages") {
              Get-ChildItem "$Env:GITHUB_WORKSPACE\.alpackages" | Select-Object Name,Length,LastWriteTime | Format-Table -AutoSize | Out-String | Write-Host
            } else { Write-Host ".alpackages not found" }

            Write-Host "ALC Version inside container:";
            Invoke-ScriptInBCContainer -containerName $containerName -scriptBlock { (Get-Command alc.exe -ErrorAction SilentlyContinue).FileVersionInfo | Select-Object FileVersion,ProductVersion }
          }
          finally {
            try {
              # Some BcContainerHelper versions don't support -Force. Remove without it and ignore errors.
              Remove-BcContainer -containerName $containerName
            }
            catch {
              Write-Host "Container cleanup warning: $($_.Exception.Message)"
            }
          }

      - name: List built artifacts before upload
        shell: pwsh
        run: |
          if (Test-Path artifacts) {
            Write-Host "Artifacts directory contents:";
            Get-ChildItem -Path artifacts -Filter *.app | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize | Out-String | Write-Host
          } else { Write-Host "Artifacts directory not found" }

      - name: Upload build artifacts (.app)
        uses: actions/upload-artifact@v4
        with:
          name: bc-app
          path: artifacts/*.app

  deploy:
    name: Deploy to Business Central (manual)
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.deploy == true }}
    runs-on: windows-latest
    environment: ${{ inputs.environment || 'Sandbox' }}
    permissions:
      contents: read
    steps:
      - name: Download built app artifact
        uses: actions/download-artifact@v4
        with:
          name: bc-app
          path: ./artifacts

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module BcContainerHelper -Scope CurrentUser -Force

      - name: Authenticate and deploy
        shell: pwsh
        env:
          BC_TENANT_ID: ${{ secrets.BC_TENANT_ID }}
          BC_ENVIRONMENT: ${{ inputs.environment || 'Sandbox' }}
          BC_CLIENT_ID: ${{ secrets.BC_CLIENT_ID }}
          BC_CLIENT_SECRET: ${{ secrets.BC_CLIENT_SECRET }}
        run: |
          if (-not (Test-Path 'artifacts')) { throw 'No artifacts folder found' }
          $appFiles = Get-ChildItem -Path 'artifacts' -Filter '*.app' | Select-Object -ExpandProperty FullName
          if (-not $appFiles) { throw 'No .app files found in artifacts' }

          $secureSecret = ConvertTo-SecureString $env:BC_CLIENT_SECRET -AsPlainText -Force
          $bcAuthContext = New-BcAuthContext -tenantId $env:BC_TENANT_ID -clientId $env:BC_CLIENT_ID -clientSecret $secureSecret

          Publish-PerTenantExtensionApps -bcAuthContext $bcAuthContext -environment $env:BC_ENVIRONMENT -appFiles $appFiles -skipVerification:$true -doNotInstallApps:$false -InstallPublishedApps:$true

