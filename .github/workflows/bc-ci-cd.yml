name: BC CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Also deploy the built app to a BC environment'
        type: boolean
        required: false
        default: false
      environment:
        description: 'Target BC environment name (Admin Center)'
        type: string
        required: false
        default: 'Sandbox'

jobs:
  build:
    name: Build AL app
    runs-on: windows-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log run context
        shell: pwsh
        run: |
          Write-Host "Workflow commit SHA: $env:GITHUB_SHA"
          Write-Host "Runner OS: $env:RUNNER_OS"

      - name: Cache BcContainerHelper module
        uses: actions/cache@v4
        with:
          path: ~\Documents\PowerShell\Modules\BcContainerHelper
          key: bccontainerhelper-${{ runner.os }}-v6
          restore-keys: |
            bccontainerhelper-${{ runner.os }}-

      - name: Setup PowerShell Gallery trust and install BcContainerHelper
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          if (Get-Module -ListAvailable -Name BcContainerHelper) {
            Write-Host "Using cached BcContainerHelper module"
            Import-Module BcContainerHelper -Force
          }
          else {
            Write-Host "Installing BcContainerHelper from PSGallery"
            Install-Module BcContainerHelper -Scope CurrentUser -Force
            Import-Module BcContainerHelper -Force
          }

      - name: Resolve BC artifacts
        id: artifacts
        shell: pwsh
        run: |
          $artifactUrl = Get-BCArtifactUrl -type 'Sandbox' -select 'Latest' -country 'gb'
          echo "artifactUrl=$artifactUrl" | Out-File -FilePath $Env:GITHUB_OUTPUT -Append

      - name: Cache AL symbols (.alpackages)
        uses: actions/cache@v4
        with:
          path: .alpackages
          key: alpkgs-${{ runner.os }}-${{ hashFiles('app.json') }}-${{ steps.artifacts.outputs.artifactUrl }}
          restore-keys: |
            alpkgs-${{ runner.os }}-${{ hashFiles('app.json') }}-
            alpkgs-${{ runner.os }}-

      - name: Build in ephemeral BC container
        shell: pwsh
        env:
          ARTIFACT_URL: ${{ steps.artifacts.outputs.artifactUrl }}
        run: |
          # Ensure BcContainerHelper is imported in this step/session
          Import-Module BcContainerHelper -ErrorAction Stop
          Write-Host "BcContainerHelper version:" (Get-Module BcContainerHelper).Version
          $cmd = Get-Command Download-BcContainerAppSymbols -ErrorAction SilentlyContinue
          if (-not $cmd) { Write-Host "Download-BcContainerAppSymbols not found in module, continuing after container creation (module may autoload)" }

          $containerName = "bcbuild$($env:GITHUB_RUN_NUMBER)"
          # Provide mandatory credentials for -auth UserPassword
          $securePwd = ConvertTo-SecureString ("P@ssw0rd!$($env:GITHUB_RUN_NUMBER)") -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ("admin", $securePwd)
          New-BcContainer `
            -accept_eula `
            -containerName $containerName `
            -artifactUrl $env:ARTIFACT_URL `
            -auth UserPassword `
            -Credential $credential `
            -updateHosts `
            -enableTaskScheduler:$false

          try {
            # Re-import module and ensure symbols downloaded to HOST first (host path shares not reliable for direct compile)
            Import-Module BcContainerHelper -ErrorAction Stop
            $symbolCmd = @(
              'Download-BcContainerAppSymbols',
              'Get-BcContainerAppSymbols',
              'Download-NavContainerAppSymbols',
              'Get-NavContainerAppSymbols'
            ) | ForEach-Object { Get-Command $_ -ErrorAction SilentlyContinue } | Select-Object -First 1
            if ($null -ne $symbolCmd) {
              Write-Host "Downloading symbols to host using: $($symbolCmd.Name)"
              try {
                & $symbolCmd.Name -containerName $containerName -appProjectFolder $Env:GITHUB_WORKSPACE -ErrorAction Stop
              } catch {
                Write-Host "Symbol download command failed: $($_.Exception.Message). Continuing, symbols may already be cached."
              }
            } else { Write-Host "No symbol download command found; continuing" }

            # Fallback: if no symbols were downloaded, try to copy *.app symbols out of the container
            $pkgPath = Join-Path $Env:GITHUB_WORKSPACE '.alpackages'
            if (-not (Test-Path $pkgPath)) { New-Item -ItemType Directory -Force -Path $pkgPath | Out-Null }
            $pkgCount = (Get-ChildItem -Path $pkgPath -Filter '*.app' -ErrorAction SilentlyContinue | Measure-Object).Count
            if ($pkgCount -eq 0) {
              Write-Host 'No .alpackages found on host; copying symbols from container applications folder'
              Invoke-ScriptInBCContainer -containerName $containerName -scriptBlock {
                $dest = 'C:\\tempSymbols'
                New-Item -ItemType Directory -Force -Path $dest | Out-Null
                Get-ChildItem -Path 'C:\\Applications' -Filter '*.app' -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
                  Copy-Item -Path $_.FullName -Destination $dest -Force
                }
                # Zip the symbols to a single file for reliable copy-out
                $zip = 'C:\\tempSymbols.zip'
                if (Test-Path $zip) { Remove-Item $zip -Force }
                Compress-Archive -Path 'C:\\tempSymbols\\*' -DestinationPath $zip -Force
              }
              # Prepare a temp directory and copy the zip from container
              $tmpDir = Join-Path $Env:GITHUB_WORKSPACE '_tmp'
              New-Item -ItemType Directory -Force -Path $tmpDir | Out-Null
              $zipLocal = Join-Path $tmpDir 'tempSymbols.zip'
              if (Test-Path $zipLocal) { Remove-Item $zipLocal -Force }
              Copy-FileFromBcContainer -containerName $containerName -containerPath 'C:\\tempSymbols.zip' -localPath $zipLocal
              Expand-Archive -Path $zipLocal -DestinationPath $pkgPath -Force
            }

            # Prepare artifacts folder on host
            New-Item -ItemType Directory -Force -Path "$Env:GITHUB_WORKSPACE\artifacts" | Out-Null

            # Download AL compiler (VSIX) on host and compile locally
            $alDir = Join-Path $Env:GITHUB_WORKSPACE '_al'
            New-Item -ItemType Directory -Force -Path $alDir | Out-Null
            $vsix = Join-Path $alDir 'al.vsix'
            $vsixOut = Join-Path $alDir 'vsix'
            Write-Host 'Downloading AL Language VSIX (latest)'
            Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com/_apis/public/gallery/publishers/ms-dynamics-smb/vsextensions/al/latest/vspackage' -OutFile $vsix
            Write-Host 'Extracting VSIX'
            Expand-Archive -Path $vsix -DestinationPath $vsixOut -Force
            $alc = Join-Path $vsixOut 'extension/bin/alc.exe'
            if (-not (Test-Path $alc)) { throw 'alc.exe not found in downloaded VSIX' }

            Write-Host "ALC Version on host:"; (Get-Item $alc).VersionInfo | Select-Object FileVersion,ProductVersion | Format-List | Out-String | Write-Host
            $args = @(
              "/project:$Env:GITHUB_WORKSPACE",
              "/packagecachepath:$pkgPath",
              "/out:$Env:GITHUB_WORKSPACE\artifacts\app.app"
            )
            Write-Host "Running ALC on host: $alc $($args -join ' ')"
            & $alc @args
            if ($LASTEXITCODE -ne 0) { throw "ALC failed on host with exit code $LASTEXITCODE" }

            # Compiled on host; no need to copy artifacts from container

            Write-Host "Listing .alpackages after compile (if present)";
            if (Test-Path "$Env:GITHUB_WORKSPACE\.alpackages") {
              Get-ChildItem "$Env:GITHUB_WORKSPACE\.alpackages" | Select-Object Name,Length,LastWriteTime | Format-Table -AutoSize | Out-String | Write-Host
            } else { Write-Host ".alpackages not found" }

            # Done
          }
          finally {
            try {
              # Some BcContainerHelper versions don't support -Force. Remove without it and ignore errors.
              Remove-BcContainer -containerName $containerName
            }
            catch {
              Write-Host "Container cleanup warning: $($_.Exception.Message)"
            }
          }

      - name: List built artifacts before upload
        shell: pwsh
        run: |
          if (Test-Path artifacts) {
            Write-Host "Artifacts directory contents:";
            Get-ChildItem -Path artifacts -Filter *.app | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize | Out-String | Write-Host
          } else { Write-Host "Artifacts directory not found" }

      - name: Upload build artifacts (.app)
        uses: actions/upload-artifact@v4
        with:
          name: bc-app
          path: artifacts/*.app

  deploy:
    name: Deploy to Business Central (manual)
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.deploy == true }}
    runs-on: windows-latest
    environment: ${{ inputs.environment || 'Sandbox' }}
    permissions:
      contents: read
    steps:
      - name: Download built app artifact
        uses: actions/download-artifact@v4
        with:
          name: bc-app
          path: ./artifacts

      - name: Install BcContainerHelper
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module BcContainerHelper -Scope CurrentUser -Force

      - name: Authenticate and deploy
        shell: pwsh
        env:
          BC_TENANT_ID: ${{ secrets.BC_TENANT_ID }}
          BC_ENVIRONMENT: ${{ inputs.environment || 'Sandbox' }}
          BC_CLIENT_ID: ${{ secrets.BC_CLIENT_ID }}
          BC_CLIENT_SECRET: ${{ secrets.BC_CLIENT_SECRET }}
        run: |
          if (-not (Test-Path 'artifacts')) { throw 'No artifacts folder found' }
          $appFiles = Get-ChildItem -Path 'artifacts' -Filter '*.app' | Select-Object -ExpandProperty FullName
          if (-not $appFiles) { throw 'No .app files found in artifacts' }

          $secureSecret = ConvertTo-SecureString $env:BC_CLIENT_SECRET -AsPlainText -Force
          $bcAuthContext = New-BcAuthContext -tenantId $env:BC_TENANT_ID -clientId $env:BC_CLIENT_ID -clientSecret $secureSecret

          Publish-PerTenantExtensionApps -bcAuthContext $bcAuthContext -environment $env:BC_ENVIRONMENT -appFiles $appFiles -skipVerification:$true -doNotInstallApps:$false -InstallPublishedApps:$true

